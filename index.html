<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VisionAI Check</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      min-height: 100vh;
    }
    h1 {
      color: #00796b;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    p {
      color: #004d40;
      font-size: 1.2em;
    }
    #chart {
      font-size: 60px;
      margin: 40px;
      color: #00695c;
      transition: all 0.3s;
    }
    #distance {
      width: 80px;
      padding: 5px;
      border: 2px solid #26a69a;
      border-radius: 5px;
      font-size: 1em;
    }
    button {
      padding: 12px 25px;
      margin: 5px;
      background-color: #26a69a;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #00796b;
    }
    #result {
      margin: 30px;
      font-size: 1.3em;
      color: #004d40;
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #controls { display: block; }
    #reset { display: none; background-color: #0288d1; }
    #reset:hover { background-color: #01579b; }
  </style>
</head>
<body>
  <h1>VisionAI Check</h1>
  <p>画面から<input id="distance" type="number" value="50" min="10" max="100">cm離れてください。</p>
  <p>「C」の開いている方向を答えてください。</p>
  <div id="chart">C</div>
  <div id="controls">
    <button onclick="checkVision('up')">上</button>
    <button onclick="checkVision('down')">下</button>
    <button onclick="checkVision('left')">左</button>
    <button onclick="checkVision('right')">右</button>
  </div>
  <button id="reset" onclick="resetTest()">再検査</button>
  <div id="result"></div>

  <script>
    const directions = ['up', 'down', 'left', 'right'];
    let currentDir = 'up';
    let score = 0;
    let total = 0;
    const maxQuestions = 10;

    // 視力計算関数（0.1〜1.5、0.1刻み）
    function calculateVision(score, distance) {
      const baseDistance = 50; // 基準距離50cm
      const scoreRatio = score / maxQuestions; // 正解率 (0〜1)
      const distanceFactor = baseDistance / distance; // 距離補正
      let vision = scoreRatio * 1.5 * distanceFactor; // 最大1.5にスケール
      vision = Math.round(vision * 10) / 10; // 0.1刻み
      return Math.max(0.1, Math.min(1.5, vision)); // 0.1〜1.5に制限
    }

    // チャートサイズ調整
    function adjustChartSize(distance) {
      const baseSize = 60; // 基準フォントサイズ(px)
      const adjustedSize = baseSize * (distance / 50);
      document.getElementById('chart').style.fontSize = `${adjustedSize}px`;
    }

    // 次の問題
    function nextChart() {
      currentDir = directions[Math.floor(Math.random() * 4)];
      document.getElementById('chart').style.transform = 
        currentDir === 'up' ? 'rotate(0deg)' :
        currentDir === 'down' ? 'rotate(180deg)' :
        currentDir === 'left' ? 'rotate(90deg)' : 'rotate(-90deg)';
    }

    // 回答チェック
    function checkVision(choice) {
      if (total < maxQuestions) { // 10問未満の場合のみ処理
        total++;
        if (choice === currentDir) score++; // 正解ならスコア加算
        if (total < maxQuestions) {
          nextChart();
        } else {
          endTest();
        }
      }
    }

    // 検査終了
    function endTest() {
      const distance = parseInt(document.getElementById('distance').value);
      const vision = calculateVision(score, distance);
      const result = `検査終了！スコア: ${score}/${maxQuestions}<br>` +
                    `推定視力: ${vision}<br>` +
                    `(距離: ${distance}cmでの測定)<br>` +
                    `※正確な視力は眼科で測定してください。`;
      document.getElementById('result').innerHTML = result;
      localStorage.setItem('lastScore', result);
      document.getElementById('controls').style.display = 'none';
      document.getElementById('reset').style.display = 'inline';
    }

    // リセット
    function resetTest() {
      score = 0;
      total = 0;
      document.getElementById('result').innerHTML = '';
      document.getElementById('controls').style.display = 'block';
      document.getElementById('reset').style.display = 'none';
      const distance = parseInt(document.getElementById('distance').value);
      adjustChartSize(distance);
      nextChart();
    }

    // 初期化
    const lastScore = localStorage.getItem('lastScore');
    if (lastScore) document.getElementById('result').innerHTML = `前回の結果:<br>${lastScore}`;
    const initialDistance = parseInt(document.getElementById('distance').value);
    adjustChartSize(initialDistance);
    nextChart();

    // 距離変更時
    document.getElementById('distance').addEventListener('change', function() {
      const distance = parseInt(this.value);
      adjustChartSize(distance);
    });
  </script>
</body>
</html>